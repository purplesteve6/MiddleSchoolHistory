<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Middle East Map Challenge | Middle School History</title>

  <!-- Global site styles -->
  <link rel="stylesheet" href="/styles.css" />

  <!-- Page-specific styles -->
  <link rel="stylesheet" href="/games/map-challenges/middle-east/middle-east.css" />
</head>

<body class="map-challenge-page">

  <!-- MAIN SITE HEADER (injected) -->
  <div id="siteHeader" data-include="/partials/main-header.html"></div>

  <!-- Full-width band under header -->
  <section class="challenge-band challenge-band--image"
           style="background-image: url('/assets/images/banners/map-challenges-banner.jpg');"
           aria-label="Middle East Map Challenge banner">
    <div class="challenge-band__bottom">
      <div class="challenge-band__inner">
        <h1 class="challenge-band__title">MIDDLE EAST MAP CHALLENGE</h1>
      </div>
    </div>
  </section>

  <main class="challenge-main" aria-label="Middle East map challenge">
    <section class="map-stage" aria-label="Map stage">

      <!-- HUD -->
      <div class="hud" aria-label="Game HUD">
        <div class="hud__prompt">
          Click: <span id="targetName">—</span>
        </div>

        <div class="hud__right">
          <div class="hud__timer" id="timer">00:00.000</div>
          <button class="hud__reset" id="resetBtn" type="button">Reset</button>
        </div>
      </div>

      <!-- SVG gets injected here -->
      <div class="map-box" id="mapBox" aria-label="Middle East map"></div>

      <!-- Begin Overlay -->
      <div class="start-overlay" id="startOverlay" aria-label="Start overlay">
        <div class="start-overlay__card">
          <div class="overlay__kicker">MAP CHALLENGE</div>
          <div class="overlay__title">MIDDLE EAST</div>

          <div class="overlay__body">
            How fast can you identify the countries of the Middle East?
          </div>

          <div class="overlay__actions">
  <button class="begin-btn" id="beginBtn" type="button">Begin</button>
</div>


          <img class="overlay__logo"
               src="/assets/images/logo/MSHistory_Logo_Small.png"
               alt="Middle School History logo" />
        </div>
      </div>
    </section>
  </main>

  <!-- FOOTER (injected) -->
  <div id="siteFooter" data-include="/partials/footer.html"></div>

  <!-- Inject header/footer -->
  <script src="/include.js"></script>

  <!-- Game logic -->
  <script>
  (function () {
    const SVG_PATH = "/games/map-challenges/middle-east/middle_east_clickable.svg";

    const COUNTRIES = [
      "bahrain","cyprus","egypt","iran","iraq","israel","jordan","kuwait",
      "lebanon","oman","qatar","saudi_arabia","syria","turkey","uae","yemen"
    ];

    // Not clickable + should NOT count as wrong
    const IGNORE = new Set(["water","borders","context_land"]);

    // Alias clicks on palestine/gaza/internal borders -> israel
    // israel_internal_borders should behave like clicking Israel for correctness,
    // but it should NOT be colored itself (it's a border layer only).
    const ALIAS = {
      palestine: "israel",
      gaza: "israel",
      israel_internal_borders: "israel",
      israel: "israel"
    };

    // Treat these SVG layers exactly like Israel for coloring/blinking
    // (DO NOT include israel_internal_borders here — it's a border layer only)
    const GROUPS = {
      israel: ["israel", "gaza", "palestine"]
    };

    // Clear classes from these extra IDs too (not in COUNTRIES list)
    const EXTRA_IDS = ["gaza", "palestine", "israel_internal_borders"];

    // Display name overrides
    const DISPLAY_NAMES = {
      uae: "United Arab Emirates (UAE)"
    };

    const LOGO_SRC = "/assets/images/logo/MSHistory_Logo_Small.png";
    const GAME_KICKER = "MAP CHALLENGE";
    const GAME_TITLE = "MIDDLE EAST";

    const mapBox = document.getElementById("mapBox");
    const overlay = document.getElementById("startOverlay");
    const beginBtn = document.getElementById("beginBtn");
    const resetBtn = document.getElementById("resetBtn");
    const targetNameEl = document.getElementById("targetName");
    const timerEl = document.getElementById("timer");

    let svgRoot = null;

    // Game state
    let remaining = [];
    let currentTarget = null;
    let tries = 0; // 0 = first attempt, 1 = second attempt
    let totalPoints = 0;

    // countries already completed (green/yellow/red) should ignore clicks
    let locked = new Set();

    let timerStart = 0;
    let timerInt = null;

    // Track pointer-down temporary red
    let tempWrongEl = null;

    function shuffle(arr){
      const a = arr.slice();
      for (let i = a.length - 1; i > 0; i--){
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

    function fmtTime(ms){
      const minutes = Math.floor(ms / 60000);
      const seconds = Math.floor((ms % 60000) / 1000);
      const millis  = ms % 1000;
      return `${String(minutes).padStart(2,"0")}:${String(seconds).padStart(2,"0")}.${String(millis).padStart(3,"0")}`;
    }

    function startTimer(){
      stopTimer();
      timerStart = Date.now();
      timerEl.textContent = "00:00.000";
      timerInt = setInterval(() => {
        timerEl.textContent = fmtTime(Date.now() - timerStart);
      }, 31);
    }

    function stopTimer(){
      if (timerInt) clearInterval(timerInt);
      timerInt = null;
    }

    function getElById(id){
      if (!svgRoot) return null;
      return svgRoot.querySelector(`#${CSS.escape(id)}`);
    }

    function getGroupIds(canonicalId){
      return GROUPS[canonicalId] ? GROUPS[canonicalId].slice() : [canonicalId];
    }

    function forEachGroupEl(canonicalId, fn){
      const ids = getGroupIds(canonicalId);
      for (const id of ids){
        const el = getElById(id);
        if (el) fn(el);
      }
    }

    function getVisualElForHit(hit){
      if (hit.raw === "israel_internal_borders"){
        return getElById("israel") || hit.el;
      }
      return hit.el;
    }

    function clearAllCountryClasses(){
      if (!svgRoot) return;

      const allIds = [...new Set([...COUNTRIES, ...EXTRA_IDS])];
      for (const id of allIds){
        const el = getElById(id);
        if (el) el.classList.remove("correct1","correct2","wrongFinal","blink","tempWrong");
      }
    }

    function setPrompt(){
      if (!currentTarget){
        targetNameEl.textContent = "Done!";
        return;
      }

      const display =
        DISPLAY_NAMES[currentTarget] ??
        currentTarget.replaceAll("_"," ");

      targetNameEl.textContent = display;
    }

    function pickNext(){
      currentTarget = remaining.shift() || null;
      tries = 0;
      setPrompt();

      if (!currentTarget){
        endGame();
      }
    }

    function endGame(){
      stopTimer();
      const elapsed = Date.now() - timerStart;

      // Average points out of 100 (same as percent)
      const avg = totalPoints / COUNTRIES.length;
      const avgPercent = `${avg.toFixed(1)}%`;

      showEndOverlay({
        title: GAME_TITLE,
        time: fmtTime(elapsed),
        scorePercent: avgPercent,
        stamp: new Date().toLocaleString()
      });
    }

    function showEndOverlay({ title, time, scorePercent, stamp }){
      const old = document.getElementById("endOverlay");
      if (old) old.remove();

      const wrap = document.createElement("div");
      wrap.id = "endOverlay";
      wrap.className = "start-overlay";
      wrap.innerHTML = `
        <div class="start-overlay__card" role="dialog" aria-modal="true" aria-label="Results">
          <div class="overlay__kicker">${GAME_KICKER}</div>
          <div class="overlay__title">${title}</div>

          <div class="results-metrics">
            <div class="results-metric">
              <div class="results-label">SCORE</div>
              <div class="results-value">${scorePercent}</div>
            </div>

            <div class="results-metric">
              <div class="results-label">TIME</div>
              <div class="results-value">${time}</div>
            </div>
          </div>

          <div class="results-completed">
            Completed: ${stamp}
          </div>

          <div class="overlay__actions">
  <button class="begin-btn" id="playAgainBtn" type="button">Play Again</button>
</div>


          <img class="overlay__logo"
               src="${LOGO_SRC}"
               alt="Middle School History logo" />
        </div>
      `;

      const stage = mapBox.closest(".map-stage");
      stage.appendChild(wrap);

      const playAgainBtn = wrap.querySelector("#playAgainBtn");
      playAgainBtn.addEventListener("click", () => {
        wrap.remove();
        resetGame(true);
      });

      // Optional: focus the button for accessibility / spacebar behavior
      playAgainBtn.focus();
    }

    function resetGame(startImmediately=false){
      stopTimer();
      document.body.classList.remove("is-playing");

      remaining = [];
      currentTarget = null;
      tries = 0;
      totalPoints = 0;

      locked = new Set();
      clearAllCountryClasses();

      targetNameEl.textContent = "—";
      timerEl.textContent = "00:00.000";

      if (overlay && !startImmediately) overlay.classList.remove("is-hidden");

      if (startImmediately) {
        if (overlay) overlay.classList.add("is-hidden");
        document.body.classList.add("is-playing");

        locked = new Set();
        remaining = shuffle(COUNTRIES);
        pickNext();
        startTimer();
      }
    }

    function normalizeClickedId(e){
      const targetEl = (e.target && e.target.closest)
        ? e.target.closest(
            "#bahrain,#cyprus,#egypt,#iran,#iraq,#israel,#jordan,#kuwait,#lebanon,#oman,#qatar,#saudi_arabia,#syria,#turkey,#uae,#yemen,#palestine,#gaza,#israel_internal_borders,#water,#borders,#context_land"
          )
        : null;

      if (!targetEl) return null;

      const raw = String(targetEl.id).toLowerCase();
      if (IGNORE.has(raw)) return null;

      const normalized = ALIAS[raw] ?? raw;
      if (!COUNTRIES.includes(normalized)) return null;

      return { raw, normalized, el: targetEl };
    }

    function flashCorrectThenRed(){
      if (!currentTarget) return;

      forEachGroupEl(currentTarget, (el) => {
        el.classList.remove("correct1","correct2");
        el.classList.add("blink");
      });

      setTimeout(() => {
        forEachGroupEl(currentTarget, (el) => {
          el.classList.remove("blink");
          el.classList.add("wrongFinal");
        });

        locked.add(currentTarget);
        pickNext();
      }, 520);
    }

    async function loadSvg(){
      const res = await fetch(SVG_PATH, { cache: "no-store" });
      if (!res.ok) throw new Error(`SVG fetch failed: ${res.status}`);
      const svgText = await res.text();

      mapBox.innerHTML = svgText;
      svgRoot = mapBox.querySelector("svg");

      if (svgRoot){
        svgRoot.setAttribute("preserveAspectRatio", "xMidYMid meet");
        svgRoot.removeAttribute("width");
        svgRoot.removeAttribute("height");
        svgRoot.style.width = "100%";
        svgRoot.style.height = "100%";
        svgRoot.style.display = "block";
      }
    }

    mapBox.addEventListener("pointerdown", (e) => {
      const hit = normalizeClickedId(e);
      if (!hit) return;
      if (!currentTarget) return;

      if (locked.has(hit.normalized) && hit.normalized !== currentTarget){
        return;
      }

      if (hit.normalized === currentTarget){
        if (tries === 0){
          totalPoints += 100;
          forEachGroupEl(currentTarget, (el) => el.classList.add("correct1"));
          locked.add(currentTarget);
          pickNext();
        } else {
          totalPoints += 50;
          forEachGroupEl(currentTarget, (el) => el.classList.add("correct2"));
          locked.add(currentTarget);
          pickNext();
        }
        return;
      }

      if (tries === 0){
        tempWrongEl = getVisualElForHit(hit);
        tempWrongEl.classList.add("tempWrong");
        tries = 1;
        try { tempWrongEl.setPointerCapture(e.pointerId); } catch(_) {}
      } else {
        flashCorrectThenRed();
        tries = 0;
      }
    });

    mapBox.addEventListener("pointerup", () => {
      if (tempWrongEl){
        tempWrongEl.classList.remove("tempWrong");
        tempWrongEl = null;
      }
    });

    mapBox.addEventListener("pointercancel", () => {
      if (tempWrongEl){
        tempWrongEl.classList.remove("tempWrong");
        tempWrongEl = null;
      }
    });

    if (beginBtn){
      beginBtn.addEventListener("click", () => {
        const endOverlay = document.getElementById("endOverlay");
        if (endOverlay) endOverlay.remove();

        if (overlay) overlay.classList.add("is-hidden");
        document.body.classList.add("is-playing");

        clearAllCountryClasses();
        totalPoints = 0;

        locked = new Set();
        remaining = shuffle(COUNTRIES);
        pickNext();
        startTimer();
      });
    }

    if (resetBtn){
      resetBtn.addEventListener("click", () => resetGame(false));
    }

    // NEW: Spacebar activates Begin / Play Again when an overlay is visible.
    document.addEventListener("keydown", (e) => {
      // Space key
      if (e.code !== "Space" && e.key !== " ") return;

      // If start overlay is up, Space should click Begin
      if (overlay && !overlay.classList.contains("is-hidden")){
        e.preventDefault();
        beginBtn?.click();
        return;
      }

      // If end overlay is up, Space should click Play Again
      const endOverlay = document.getElementById("endOverlay");
      if (endOverlay){
        const playAgainBtn = endOverlay.querySelector("#playAgainBtn");
        if (playAgainBtn){
          e.preventDefault();
          playAgainBtn.click();
        }
      }
    });

    loadSvg().catch(err => {
      console.error(err);
      mapBox.innerHTML = "<div style='padding:16px;color:#fff'>Could not load map SVG.</div>";
    });
  })();
  </script>
</body>
</html>
